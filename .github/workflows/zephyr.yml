name: Zephyr Firmware CI

on:
  push:
  pull_request:
  workflow_call:

jobs:
  build:
    name: Build Zephyr Firmware
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        board:
          - name: nicla_vision
            board: arduino_nicla_vision/stm32h747xx/m7
            overlay: boards/nicla-vision.overlay
            conf: boards/nicla.conf
            sysbuild: true

          - name: feather_esp32s3
            board: adafruit_feather_esp32s3/esp32s3/procpu
            overlay: boards/adafruit_feather_s3.overlay
            conf: boards/adafruit_feather_s3.conf
            sysbuild: true
            # clean_micro_ros: true

          - name: pico_plus_2w
            board: pico_plus2/rp2350b/m33
            overlay: boards/pimoroni_pico_plus_2w.overlay
            conf: boards/pimoroni_pico_plus_2w.conf
            sysbuild: false
            # clean_micro_ros: true

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune -af

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            git cmake ninja-build gperf ccache \
            dfu-util device-tree-compiler \
            python3 python3-dev python3-venv \
            wget xz-utils file make \
            gcc gcc-multilib g++-multilib \
            libsdl2-dev libmagic1

      - name: Set up Python venv
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install \
            west patool pykwalify \
            catkin_pkg lark-parser \
            'empy<4.0.0' \
            colcon-common-extensions

      - name: Initialize Zephyr workspace
        working-directory: zephyr_workspace
        run: |
          . ../.venv/bin/activate

          # repo root contains west.yml
          west init .
          west update --narrow
          west packages pip --install

      - name: Install Zephyr SDK
        working-directory: zephyr_workspace
        run: |
          . ../.venv/bin/activate
          west sdk install

      - name: Build firmware (${{ matrix.board.name }})
        working-directory: zephyr_workspace
        run: |
          . ../.venv/bin/activate

          if [[ "${{ matrix.board.clean_micro_ros }}" == "true" ]]; then
            rm -rf \
              modules/libmicroros/micro_ros_src/build \
              modules/libmicroros/micro_ros_src/install \
              modules/libmicroros/micro_ros_src/log
          fi

          west build -p always \
            -b ${{ matrix.board.board }} \
            ${{ matrix.board.sysbuild && '--sysbuild' || '' }} \
            "zephyr_sensor_node" -- \
            -DDTC_OVERLAY_FILE=${{ matrix.board.overlay }} \
            -DEXTRA_CONF_FILE=${{ matrix.board.conf }}

/**
 * @file iim42652_zephyr.cpp
 * @brief TDK IIM-42652 6-axis IMU driver for Zephyr RTOS
 * @version 1.0
 * @date 2024
 *
 * Converted from Arduino RAK12033 library to Zephyr RTOS
 * Original copyright (c) 2022 RAKwireless
 */
#include <stdint.h>
#include <stdlib.h>
#include <zephyr/drivers/sensor.h>
#ifndef IIM42652_H
#define IIM42652_H

/* ============================================================================
 * Register Definitions
 * ============================================================================ */

// Device address
#define IIM42652_I2C_ADDR 0x69

// User Bank 0 Registers
#define IIM42652_REG_DEVICE_CONFIG 0x11
#define IIM42652_REG_DRIVE_CONFIG 0x13
#define IIM42652_REG_INT_CONFIG 0x14
#define IIM42652_REG_FIFO_CONFIG 0x16
#define IIM42652_REG_TEMP_DATA1_UI 0x1D
#define IIM42652_REG_TEMP_DATA0_UI 0x1E
#define IIM42652_REG_ACCEL_DATA_X1_UI 0x1F
#define IIM42652_REG_ACCEL_DATA_X0_UI 0x20
#define IIM42652_REG_ACCEL_DATA_Y1_UI 0x21
#define IIM42652_REG_ACCEL_DATA_Y0_UI 0x22
#define IIM42652_REG_ACCEL_DATA_Z1_UI 0x23
#define IIM42652_REG_ACCEL_DATA_Z0_UI 0x24
#define IIM42652_REG_GYRO_DATA_X1_UI 0x25
#define IIM42652_REG_GYRO_DATA_X0_UI 0x26
#define IIM42652_REG_GYRO_DATA_Y1_UI 0x27
#define IIM42652_REG_GYRO_DATA_Y0_UI 0x28
#define IIM42652_REG_GYRO_DATA_Z1_UI 0x29
#define IIM42652_REG_GYRO_DATA_Z0_UI 0x2A
#define IIM42652_REG_INT_STATUS 0x2D
#define IIM42652_REG_INT_STATUS2 0x37
#define IIM42652_REG_INT_STATUS3 0x38
#define IIM42652_REG_SIGNAL_PATH_RESET 0x4B
#define IIM42652_REG_INTF_CONFIG0 0x4C
#define IIM42652_REG_INTF_CONFIG1 0x4D
#define IIM42652_REG_PWR_MGMT0 0x4E
#define IIM42652_REG_GYRO_CONFIG0 0x4F
#define IIM42652_REG_ACCEL_CONFIG0 0x50
#define IIM42652_REG_GYRO_CONFIG1 0x51
#define IIM42652_REG_GYRO_ACCEL_CONFIG0 0x52
#define IIM42652_REG_ACCEL_CONFIG1 0x53
#define IIM42652_REG_APEX_CONFIG0 0x56
#define IIM42652_REG_SMD_CONFIG 0x57
#define IIM42652_REG_INT_CONFIG0 0x63
#define IIM42652_REG_INT_CONFIG1 0x64
#define IIM42652_REG_INT_SOURCE0 0x65
#define IIM42652_REG_INT_SOURCE1 0x66
#define IIM42652_REG_WHO_AM_I 0x75
#define IIM42652_REG_BANK_SEL 0x76

// User Bank 4 Registers
#define IIM42652_REG_APEX_CONFIG1 0x40
#define IIM42652_REG_ACCEL_WOM_X_THR 0x4A
#define IIM42652_REG_ACCEL_WOM_Y_THR 0x4B
#define IIM42652_REG_ACCEL_WOM_Z_THR 0x4C
#define IIM42652_REG_INT_SOURCE6 0x4D

// Chip ID
#define IIM42652_CHIP_ID 0x6F

// Bank Selection
#define IIM42652_SET_BANK_0 0x00
#define IIM42652_SET_BANK_1 0x01
#define IIM42652_SET_BANK_2 0x02
#define IIM42652_SET_BANK_3 0x03
#define IIM42652_SET_BANK_4 0x04

// Power Management
#define IIM42652_SET_TEMPERATURE_DISABLED 0x20
#define IIM42652_SET_GYRO_TLOW_NOISE_MODE 0x0C
#define IIM42652_SET_ACCEL_LOW_NOISE_MODE 0x03

// Bit Masks and Positions
#define BIT_ACCEL_CONFIG0_FS_SEL_POS 5
#define BIT_ACCEL_CONFIG0_FS_SEL_MASK (7 << BIT_ACCEL_CONFIG0_FS_SEL_POS)
#define BIT_ACCEL_CONFIG0_ODR_POS 0
#define BIT_ACCEL_CONFIG0_ODR_MASK 0x0F
#define BIT_GYRO_CONFIG0_FS_SEL_POS 5
#define BIT_GYRO_CONFIG0_FS_SEL_MASK (7 << BIT_GYRO_CONFIG0_FS_SEL_POS)
#define BIT_GYRO_CONFIG0_ODR_POS 0
#define BIT_GYRO_CONFIG0_ODR_MASK 0x0F
#define BIT_PWR_MGMT_0_ACCEL_MODE_MASK 0x03
#define BIT_ACCEL_LP_CLK_SEL_MASK 0x07

// Power Management Constants
#define IIM42652_PWR_MGMT_0_ACCEL_MODE_LP 0x02
#define IIM42652_INTF_CONFIG1_ACCEL_LP_CLK_WUOSC 0x03

// Wake on Motion
#define X_INT1_EN 0x01
#define Y_INT1_EN 0x02
#define Z_INT1_EN 0x04

/* ============================================================================
 * Enumerations and Structures
 * ============================================================================ */

/**
 * @brief Accelerometer Full Scale Range selection
 */
typedef enum {
    IIM42652_ACCEL_CONFIG0_FS_SEL_16g = (0x0 << BIT_ACCEL_CONFIG0_FS_SEL_POS),
    IIM42652_ACCEL_CONFIG0_FS_SEL_8g = (0x1 << BIT_ACCEL_CONFIG0_FS_SEL_POS),
    IIM42652_ACCEL_CONFIG0_FS_SEL_4g = (0x2 << BIT_ACCEL_CONFIG0_FS_SEL_POS),
    IIM42652_ACCEL_CONFIG0_FS_SEL_2g = (0x3 << BIT_ACCEL_CONFIG0_FS_SEL_POS),
} IIM42652_ACCEL_CONFIG0_FS_SEL_t;

/**
 * @brief Accelerometer Output Data Rate selection
 */
typedef enum {
    IIM42652_ACCEL_CONFIG0_ODR_32_KHZ = 0x1,
    IIM42652_ACCEL_CONFIG0_ODR_16_KHZ = 0x2,
    IIM42652_ACCEL_CONFIG0_ODR_8_KHZ = 0x3,
    IIM42652_ACCEL_CONFIG0_ODR_4_KHZ = 0x4,
    IIM42652_ACCEL_CONFIG0_ODR_2_KHZ = 0x5,
    IIM42652_ACCEL_CONFIG0_ODR_1_KHZ = 0x6,
    IIM42652_ACCEL_CONFIG0_ODR_200_HZ = 0x7,
    IIM42652_ACCEL_CONFIG0_ODR_100_HZ = 0x8,
    IIM42652_ACCEL_CONFIG0_ODR_50_HZ = 0x9,
    IIM42652_ACCEL_CONFIG0_ODR_25_HZ = 0xA,
    IIM42652_ACCEL_CONFIG0_ODR_12_5_HZ = 0xB,
    IIM42652_ACCEL_CONFIG0_ODR_6_25_HZ = 0xC,
    IIM42652_ACCEL_CONFIG0_ODR_3_125_HZ = 0xD,
    IIM42652_ACCEL_CONFIG0_ODR_1_5625_HZ = 0xE,
    IIM42652_ACCEL_CONFIG0_ODR_500_HZ = 0xF,
} IIM42652_ACCEL_CONFIG0_ODR_t;

/**
 * @brief Gyroscope Full Scale Range selection
 */
typedef enum {
    IIM42652_GYRO_CONFIG0_FS_SEL_2000dps = (0 << BIT_GYRO_CONFIG0_FS_SEL_POS),
    IIM42652_GYRO_CONFIG0_FS_SEL_1000dps = (1 << BIT_GYRO_CONFIG0_FS_SEL_POS),
    IIM42652_GYRO_CONFIG0_FS_SEL_500dps = (2 << BIT_GYRO_CONFIG0_FS_SEL_POS),
    IIM42652_GYRO_CONFIG0_FS_SEL_250dps = (3 << BIT_GYRO_CONFIG0_FS_SEL_POS),
    IIM42652_GYRO_CONFIG0_FS_SEL_125dps = (4 << BIT_GYRO_CONFIG0_FS_SEL_POS),
    IIM42652_GYRO_CONFIG0_FS_SEL_62dps = (5 << BIT_GYRO_CONFIG0_FS_SEL_POS),
    IIM42652_GYRO_CONFIG0_FS_SEL_31dps = (6 << BIT_GYRO_CONFIG0_FS_SEL_POS),
    IIM42652_GYRO_CONFIG0_FS_SEL_16dps = (7 << BIT_GYRO_CONFIG0_FS_SEL_POS),
} IIM42652_GYRO_CONFIG0_FS_SEL_t;

/**
 * @brief Gyroscope Output Data Rate selection
 */
typedef enum {
    IIM42652_GYRO_CONFIG0_ODR_32_KHZ = 0x01,
    IIM42652_GYRO_CONFIG0_ODR_16_KHZ = 0x02,
    IIM42652_GYRO_CONFIG0_ODR_8_KHZ = 0x03,
    IIM42652_GYRO_CONFIG0_ODR_4_KHZ = 0x04,
    IIM42652_GYRO_CONFIG0_ODR_2_KHZ = 0x05,
    IIM42652_GYRO_CONFIG0_ODR_1_KHZ = 0x06,
    IIM42652_GYRO_CONFIG0_ODR_200_HZ = 0x07,
    IIM42652_GYRO_CONFIG0_ODR_100_HZ = 0x08,
    IIM42652_GYRO_CONFIG0_ODR_50_HZ = 0x09,
    IIM42652_GYRO_CONFIG0_ODR_25_HZ = 0x0A,
    IIM42652_GYRO_CONFIG0_ODR_12_5_HZ = 0x0B,
    IIM42652_GYRO_CONFIG0_ODR_500_HZ = 0x0F,
} IIM42652_GYRO_CONFIG0_ODR_t;

/**
 * @brief Axis data structure
 */
typedef struct {
    int16_t x;
    int16_t y;
    int16_t z;
} IIM42652_axis_t;

struct iim42652_vector3_data {
    float x;
    float y;
    float z;
};

#endif  // IIM42652_H